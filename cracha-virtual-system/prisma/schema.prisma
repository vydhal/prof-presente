// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  ORGANIZER
  CHECKIN_COORDINATOR
  TEACHER
  GESTOR_ESCOLA
  SPEAKER // Novo perfil
  CERIMONIAL // Gestão de espaços e eventos
}



model Question {
  id        String   @id @default(uuid())
  text      String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  
  isApproved Boolean @default(false)
  isAnswered Boolean @default(false)
  isHighlighted Boolean @default(false) // Pergunta em destaque no telão
  votes      Int     @default(0)

  @@index([eventId])
}

model Giveaway {
  id        String   @id @default(uuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  prize     String
  winnerId  String?
  winner    User?    @relation(fields: [winnerId], references: [id])
  createdAt DateTime @default(now())

  @@index([eventId])
}

enum EnrollmentStatus {
  PENDING
  APPROVED
  CANCELLED
  REJECTED
}

enum WorkShift {
  MANHA
  TARDE
  NOITE
  INTEGRAL
}

enum ContractType {
  EFETIVO
  PRESTADOR
  ESTUDANTE
  EXTERNO
}

enum TeachingSegment {
  INFANTIL
  FUNDAMENTAL1
  FUNDAMENTAL2
  EJA
  ADMINISTRATIVO
  SUPERIOR
}

model User {
  id          String    @id @default(uuid())
  name        String
  email       String    @unique
  password    String
  cpf         String?   @unique
  birthDate   DateTime
  phone       String?
  address     String?
  photoUrl    String?
  role        UserRole  @default(TEACHER)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  neighborhood    String?         // Bairro
  // workShifts      WorkShift[]     // <-- ADICIONE ESTA (NO PLURAL) - SQLite não suporta array
  workShifts      String?         // Adaptado para SQLite
  contractType    ContractType?   // Tipo de vínculo
  // teachingSegments TeachingSegment[] // <-- ADICIONE ESTA (NO PLURAL) - SQLite não suporta array
  teachingSegments String?        // Adaptado para SQLite
  professionId    String?         @map("profession_id")
  certificateLogs CertificateLog[]
  hasCompletedOnboarding  Boolean   @default(false) @map("has_completed_onboarding")
  hasConsentFacialRecognition Boolean @default(false) @map("has_consent_facial_recognition")
  faceDescriptor              Json?   @map("face_descriptor") // Armazena o vetor facial

  // Relacionamentos
  enrollments   Enrollment[]
  userAwards    UserAward[]
  userBadge     UserBadge?
  profession    Profession? @relation(fields: [professionId], references: [id], onDelete: SetNull) // Novo relacionamento
  workplaces    Workplace[] @relation("UserWorkplaces")
  createdEvents Event[] @relation("CreatedEvents") // Eventos criados pelo usuário
  questions     Question[]
  wonGiveaways  Giveaway[]
  staffEvents   EventStaff[]
  trackEnrollments TrackEnrollment[]
  spaceReservations SpaceReservation[]


  @@index([email])
  @@index([role])
  @@index([professionId]) 
  @@index([createdAt])
  @@map("users")
}

model Profession {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  users User[]

  @@map("professions")
}

model Event {
  id           String    @id @default(uuid())
  title        String
  description  String
  startDate    DateTime
  endDate      DateTime
  location     String
  maxAttendees Int?
  imageUrl     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // NOVOS CAMPOS: Detalhes do evento
  schedule        String?   // Descrição da programação (texto livre ou JSON string)
  speakerName     String?   @map("speaker_name")
  speakerRole     String?   @map("speaker_role")
  speakerPhotoUrl String?   @map("speaker_photo_url")
  mapLink         String?   @map("map_link")

   // NOVOS CAMPOS: Para o crachá impresso personalizado
  badgeTemplateUrl    String?   @map("badge_template_url")
  badgeTemplateConfig Json?     @map("badge_template_config")

  // --- NOVOS CAMPOS PARA EVENTOS PRIVADOS ---
  isPrivate Boolean @default(false)
  creatorId String? @map("creator_id")
  creator   User?   @relation("CreatedEvents", fields: [creatorId], references: [id], onDelete: SetNull)

  // Relacionamento de Pai-Filho
  parentId     String?     @map("parent_id")
  parent       Event?      @relation("EventTree", fields: [parentId], references: [id], onDelete: SetNull)
  children     Event[]     @relation("EventTree")

  // Campo para o template do certificado (apenas no evento "pai")
  certificateTemplateUrl String? @map("certificate_template_url")
  certificateTemplateConfig Json? @map("certificate_template_config")
  certificateLogs CertificateLog[]



  // Relacionamentos
  enrollments Enrollment[]
  questions   Question[]
  giveaways   Giveaway[]
  staff       EventStaff[]
  trackEvents TrackEvent[]
  userCheckins UserCheckin[]

  @@index([startDate])
  @@index([endDate])
  @@index([parentId])
  @@index([creatorId])
  @@index([createdAt])
  @@map("events")
}

model Enrollment {
  id             String           @id @default(uuid())
  userId         String
  eventId        String
  enrollmentDate DateTime         @default(now())
  status         EnrollmentStatus @default(APPROVED)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relacionamentos
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  event            Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  courseEvaluation CourseEvaluation?

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([status])
  @@index([enrollmentDate])
  @@map("enrollments")
}

model Award {
  id          String   @id @default(uuid())
  name        String
  description String?
  imageUrl    String?
  criteria    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  userAwards UserAward[]

  @@index([createdAt])
  @@map("awards")
}

model UserAward {
  id        String   @id @default(uuid())
  userId    String
  awardId   String
  awardedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  award Award @relation(fields: [awardId], references: [id], onDelete: Cascade)

  @@unique([userId, awardId])
  @@index([userId])
  @@index([awardId])
  @@index([awardedAt])
  @@map("user_awards")
}

model CourseEvaluation {
  id           String   @id @default(uuid())
  enrollmentId String   @unique
  rating       Int      @default(1) // 1 a 5 estrelas
  comment      String?
  evaluatedAt  DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([rating])
  @@index([evaluatedAt])
  @@index([createdAt])
  @@map("course_evaluations")
}

model UserBadge {
  id             String    @id @default(uuid())
  userId         String    @unique
  badgeCode      String    @unique
  qrCodeUrl      String
  badgeImageUrl  String
  issuedAt       DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Relacionamentos
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userCheckins   UserCheckin[]

  @@index([badgeCode])
  @@index([issuedAt])
  @@index([createdAt])
  @@map("user_badges")
}

model UserCheckin {
  id            String      @id @default(uuid())
  userBadgeId   String
  eventId       String
  checkinTime   DateTime    @default(now())
  location      String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relacionamentos
  userBadge UserBadge @relation(fields: [userBadgeId], references: [id], onDelete: Cascade)
  event     Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userBadgeId])
  @@index([eventId])
  @@index([checkinTime])
  @@index([createdAt])
  @@index([eventId, userBadgeId]) // OTIMIZAÇÃO: Busca rápida de checkin específico
  @@map("user_checkins")
}

model Workplace {
  id          String   @id @default(uuid())
  name        String
  description String?
  city        String
  state       String
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relacionamentos
  users User[] @relation("UserWorkplaces")

  @@index([name])
  @@index([city])
  @@index([state])
  @@map("workplaces")
}

model CertificateLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  status    String // "SUCCESS" ou "FAILED"
  details   String?  // Para mensagens de erro

  eventId   String?
  event     Event?    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  trackId   String?
  track     LearningTrack? @relation(fields: [trackId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([trackId])
  @@index([userId])
}

model EventStaff {
  id        String   @id @default(uuid())
  userId    String
  eventId   String
  role      UserRole // CHECKIN_COORDINATOR ou SPEAKER
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([role])
  @@map("event_staff")
}

model LearningTrack {
  id          String   @id @default(uuid())
  title       String
  description String
  imageUrl    String?

  // Campo para o template do certificado
  certificateTemplateUrl String? @map("certificate_template_url")
  certificateTemplateConfig Json? @map("certificate_template_config")
  certificateLogs CertificateLog[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  events      TrackEvent[]
  enrollments TrackEnrollment[]

  @@map("learning_tracks")
}

model TrackEvent {
  id        String   @id @default(uuid())
  trackId   String
  eventId   String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  track LearningTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  event Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([trackId, eventId])
  @@map("track_events")
}

model TrackEnrollment {
  id             String    @id @default(uuid())
  trackId        String
  userId         String
  progress       Float     @default(0)
  isCompleted    Boolean   @default(false)
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  track LearningTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  user  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([trackId, userId])
  @@map("track_enrollments")
}


model Banner {
  id          String   @id @default(uuid())
  title       String
  description String?
  imageUrl    String
  linkUrl     String?  @map("link_url")
  order       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

model SystemSettings {
  id             String   @id @default(uuid())
  platformName   String   @default("SEDUC Eventos")
  logoUrl        String?  @map("logo_url")
  faviconUrl     String?  @map("favicon_url")
  primaryColor   String   @default("#137fec") @map("primary_color")
  reservationConfig Json?   @map("reservation_config") // Configurações dinâmicas de equipamentos e setores
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("system_settings")
}

model Space {
  id          String   @id @default(uuid())
  name        String
  capacity    Int?
  description String?
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  reservations SpaceReservation[]

  @@map("spaces")
}

model Equipment {
  id            String   @id @default(uuid())
  name          String   @unique
  totalQuantity Int      @default(0) @map("total_quantity")
  icon          String?  @default("Layout")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("equipments")
}

enum ReservationStatus {
  PENDING
  APPROVED
  REJECTED
  REALLOCATED
}

model SpaceReservation {
  id             String            @id @default(uuid())
  spaceId        String            @map("space_id")
  requesterId    String            @map("requester_id")
  eventTitle     String            @map("event_title")
  requesterName  String            @map("requester_name")
  oneDocNumber   String?           @map("one_doc_number") // Número do chamado 1Doc
  needsCerimonial Boolean          @default(false) @map("needs_cerimonial") // Necessita de suporte do cerimonial
  eventScriptUrl String?           @map("event_script_url") // Link Google Docs da minuta/roteiro
  sector         String
  date           DateTime
  startTime      DateTime?         @map("start_time")
  endTime        DateTime?         @map("end_time")
  description    String?
  status         ReservationStatus @default(PENDING)
  observations   String?
  equipment      Json?             // { som: boolean, mic: boolean, datashow: boolean, notebook: boolean, mesa: boolean, cadeiras: boolean }
  reallocatedTo  String?           @map("reallocated_to")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  space     Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  requester User  @relation(fields: [requesterId], references: [id], onDelete: Cascade)

  @@map("space_reservations")
}
